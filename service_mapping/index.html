<!DOCTYPE html>
<html>
<head>
    <title>Contact Mapping Made Easy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .header {
            background: #4a86e8;
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
        }
        .info-box {
            background: #e8f0fe;
            border-left: 4px solid #4a86e8;
            padding: 10px;
            margin: 20px 0;
        }
        .mapping-rule { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            display: flex; 
            align-items: center;
            gap: 15px; 
            background: #f8f9fa;
            border-radius: 5px;
        }
        .form-select {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        button { 
            padding: 10px 20px; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .remove-btn { background: #ea4335; color: white; }
        .add-btn { background: #34a853; color: white; font-size: 18px; }
        .save-btn { background: #4285f4; color: white; font-size: 18px; }
        .big-arrow { font-size: 24px; color: #666; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        .helper-text { font-size: 12px; color: #666; }
        .loading-indicator {
            display: none;
            text-align: center;
            margin: 10px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Map Your Contacts</h1>
            <p>Tell us how to transform your contact information</p>
        </div>
        
        <div class="info-box">
            <h3>How it works:</h3>
            <ol>
                <li>Choose which fields from Oggo should go to HubSpot</li>
                <li>Click the green "+" button to add a new mapping</li>
                <li>Click the blue "Save" button when you're done</li>
            </ol>
        </div>

        <div style="margin: 20px 0;">
            <h3>Step 1: Select which data type you're mapping</h3>
            <select id="entity-type" class="form-select" onchange="onEntityTypeChange()">
                <option value="">Loading entity types...</option>
            </select>
            <div id="entity-type-error" class="alert alert-danger mt-2" style="display: none;"></div>
            <button onclick="loadMapping()" class="btn btn-secondary mt-2">Load Current Settings</button>
        </div>

        <h3>Step 2: Define your field mappings</h3>
        <div id="loading-fields" class="loading-indicator">Loading available fields...</div>
        <div id="mapping-rules">
            <!-- Rules will appear here -->
        </div>
        
        <button class="add-btn mt-3" onclick="addRule()">+ Add New Field Mapping</button>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="save-btn" onclick="saveMapping()">üíæ Save All Settings</button>
        </div>

        <hr style="margin: 30px 0;">
        
        <div>
            <h3>Import/Export Settings</h3>
            <p>Save your settings to a file or load them from a saved file</p>
            <div style="margin: 10px 0;">
                <button onclick="exportMapping()" class="btn btn-primary">üì• Download Settings</button>
                <input type="file" id="file-input" accept=".json" style="display: none;">
                <button onclick="document.getElementById('file-input').click()" class="btn btn-secondary">üì§ Upload Settings</button>
            </div>
        </div>

        <div id="test-section" style="margin-top: 30px;">
            <h3>Test Your Mapping</h3>
            <p>See how your data will look after transformation</p>
            <button onclick="testMapping()" class="btn btn-info">üîç Test with Sample Data</button>
            <div id="test-results" style="margin-top: 15px; display: none;"></div>
        </div>
    </div>

    <script>
        // Field options for different entity types
        let fieldOptions = {
            contact: { source: [], target: [] },
            project: { source: [], target: [] },
            contract: { source: [], target: [] }
        };

        // Track if fields are loaded for current entity type
        let fieldsLoaded = false;

        // Function to handle entity type change
        function onEntityTypeChange() {
            const entityType = document.getElementById('entity-type').value;
            if (entityType) {
                // Clear existing rules when changing entity type
                document.getElementById('mapping-rules').innerHTML = '';
                // Load field options for the new entity type
                loadFieldOptions();
            }
        }

        // Function to add a new mapping rule
        function addRule(sourceValue = '', targetValue = '') {
            const rulesDiv = document.getElementById('mapping-rules');
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'mapping-rule';
            
            // Get the current entity type
            const entityType = document.getElementById('entity-type').value;
            
            // Get the appropriate field options
            const sourceOptions = fieldOptions[entityType]?.source || [];
            const targetOptions = fieldOptions[entityType]?.target || [];
            
            // Create dropdown options HTML
            let sourceOptionsHtml = '<option value="">Select a field...</option>';
            sourceOptions.forEach(option => {
                const selected = option.value === sourceValue ? 'selected' : '';
                sourceOptionsHtml += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            
            let targetOptionsHtml = '<option value="">Select a field...</option>';
            targetOptions.forEach(option => {
                const selected = option.value === targetValue ? 'selected' : '';
                targetOptionsHtml += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            
            // Create the rule HTML
            ruleDiv.innerHTML = `
                <div style="flex: 1;">
                    <label>From Oggo Field:</label>
                    <select class="form-select source-field">
                        ${sourceOptionsHtml}
                    </select>
                    <div class="helper-text">What it's called in your system</div>
                </div>
                
                <div class="big-arrow">‚Üí</div>
                
                <div style="flex: 1;">
                    <label>To HubSpot Field:</label>
                    <select class="form-select target-field">
                        ${targetOptionsHtml}
                    </select>
                    <div class="helper-text">What it should become in HubSpot</div>
                </div>
                
                <button class="remove-btn" onclick="removeRule(this)">‚úï</button>
            `;
            
            rulesDiv.appendChild(ruleDiv);
        }

        // Function to remove a mapping rule
        function removeRule(button) {
            if (confirm('Are you sure you want to remove this mapping?')) {
                button.parentElement.remove();
            }
        }

        // Function to load entity types dynamically
        function loadEntityTypes() {
            fetch('/api/entity-types')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error("API Error:", data.error);
                        throw new Error(data.error);
                    }
                    
                    const entityTypeSelect = document.getElementById('entity-type');
                    entityTypeSelect.innerHTML = '';
                    
                    if (data.entity_types && data.entity_types.length > 0) {
                        data.entity_types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.label;
                            entityTypeSelect.appendChild(option);
                        });                        
                        // Load field options for the first entity type
                        loadFieldOptions();
                    } else {
                        console.warn("No entity types found in the API response");
                        entityTypeSelect.innerHTML = '<option value="">No entity types available</option>';
                        document.getElementById('entity-type-error').textContent = 
                            'No entity types could be discovered. Please check your service configuration.';
                        document.getElementById('entity-type-error').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error("Error loading entity types:", err);
                    
                    const entityTypeSelect = document.getElementById('entity-type');
                    entityTypeSelect.innerHTML = '<option value="">Error loading types</option>';
                    
                    document.getElementById('entity-type-error').textContent = 
                        `Could not load entity types: ${err.message}. Please check your service configuration.`;
                    document.getElementById('entity-type-error').style.display = 'block';
                    
                    document.getElementById('entity-type').disabled = true;
                    document.querySelector('button[onclick="loadMapping()"]').disabled = true;
                });
        }

        // Function to load source fields dynamically from the API
        function loadFieldOptions() {
            const entityType = document.getElementById('entity-type').value;
            const loadingIndicator = document.getElementById('loading-fields');
            
            if (!entityType) {
                console.warn('No entity type selected');
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            fieldsLoaded = false;
            
            // Load source fields
            const sourcePromise = fetch(`/api/source-fields/${entityType}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.fields && data.fields.length > 0) {
                        fieldOptions[entityType].source = data.fields;
                        console.log(`Loaded ${data.fields.length} source fields for ${entityType}`);
                    } else {
                        console.warn(`No source fields found for ${entityType}`);
                        setFallbackSourceFields(entityType);
                    }
                });
            
            // Load target fields
            const targetPromise = fetch(`/api/target-fields/${entityType}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.fields && data.fields.length > 0) {
                        fieldOptions[entityType].target = data.fields;
                        console.log(`Loaded ${data.fields.length} target fields for ${entityType}`);
                    } else {
                        console.warn(`No target fields found for ${entityType}`);
                        setFallbackTargetFields(entityType);
                    }
                });
            
            // When both promises complete
            Promise.all([sourcePromise, targetPromise])
                .then(() => {
                    loadingIndicator.style.display = 'none';
                    fieldsLoaded = true;
                    console.log(`‚úÖ Field options loaded successfully for ${entityType}`);
                })
                .catch(err => {
                    loadingIndicator.style.display = 'none';
                    console.error("Error loading fields:", err);
                    alert(`Could not load fields: ${err.message}\nUsing default fields instead.`);
                    
                    setFallbackSourceFields(entityType);
                    setFallbackTargetFields(entityType);
                    fieldsLoaded = true;
                });
        }

        // Function to set fallback source fields if API fails
        function setFallbackSourceFields(entityType) {
            if (entityType === 'contact') {
                fieldOptions[entityType].source = [
                    { value: "id", label: "ID" },
                    { value: "first_name", label: "First Name" },
                    { value: "last_name", label: "Last Name" },
                    { value: "email", label: "Email Address" },
                    { value: "phone", label: "Phone Number" },
                    { value: "company", label: "Company Name" }
                ];
            } else if (entityType === 'project') {
                fieldOptions[entityType].source = [
                    { value: "id", label: "ID" },
                    { value: "name", label: "Project Name" },
                    { value: "description", label: "Description" },
                    { value: "status", label: "Status" },
                    { value: "start_date", label: "Start Date" },
                    { value: "end_date", label: "End Date" },
                    { value: "budget", label: "Budget" }
                ];
            } else if (entityType === 'contract') {
                fieldOptions[entityType].source = [
                    { value: "id", label: "ID" },
                    { value: "title", label: "Contract Title" },
                    { value: "value", label: "Contract Value" },
                    { value: "status", label: "Status" },
                    { value: "start_date", label: "Start Date" },
                    { value: "end_date", label: "End Date" }
                ];
            }
        }

        // Function to set fallback target fields if API fails
        function setFallbackTargetFields(entityType) {
            if (entityType === 'contact') {
                fieldOptions[entityType].target = [
                    { value: "hubspot_id", label: "HubSpot ID" },
                    { value: "properties.firstname", label: "First Name" },
                    { value: "properties.lastname", label: "Last Name" },
                    { value: "properties.email", label: "Email" },
                    { value: "properties.phone", label: "Phone" },
                    { value: "properties.company", label: "Company" }
                ];
            } else if (entityType === 'project') {
                fieldOptions[entityType].target = [
                    { value: "hubspot_id", label: "HubSpot ID" },
                    { value: "properties.name", label: "Project Name" },
                    { value: "properties.description", label: "Description" },
                    { value: "properties.hs_pipeline_stage", label: "Pipeline Stage" },
                    { value: "properties.start_date", label: "Start Date" },
                    { value: "properties.end_date", label: "End Date" },
                    { value: "properties.budget", label: "Budget" }
                ];
            } else if (entityType === 'contract') {
                fieldOptions[entityType].target = [
                    { value: "hubspot_id", label: "HubSpot ID" },
                    { value: "properties.contract_name", label: "Contract Name" },
                    { value: "properties.contract_value", label: "Contract Value" },
                    { value: "properties.status", label: "Status" },
                    { value: "properties.start_date", label: "Start Date" },
                    { value: "properties.end_date", label: "End Date" }
                ];
            }
        }

        function loadMapping() {
            const entityType = document.getElementById('entity-type').value;
            
            if (!entityType) {
                alert('Please select an entity type first');
                return;
            }
            
            // Check if fields are loaded first
            if (!fieldsLoaded) {
                alert('Please wait for field options to load first, then try again.');
                return;
            }
            
            fetch(`/mappings/${entityType}`)
                .then(response => {
                    console.log(`Response status: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received mapping data:', data);
                    
                    // Clear existing rules first
                    document.getElementById('mapping-rules').innerHTML = '';
                    
                    if (data.error) {
                        console.warn(`No existing mapping found for ${entityType}: ${data.error}`);
                        alert(`No existing mapping found for ${entityType}. Please create and save a mapping first.`);
                        return;
                    }
                    
                    // Check if we have rules in the response
                    const rules = data.rules || {};
                    console.log('Mapping rules:', rules);
                    
                    if (Object.keys(rules).length === 0) {
                        console.warn(`No mapping rules found for ${entityType}`);
                        alert(`No mapping rules found for ${entityType}. The mapping file exists but is empty.`);
                        return;
                    }
                    
                    // Add rules from the loaded data
                    let rulesCount = 0;
                    for (const [source, target] of Object.entries(rules)) {
                        console.log(`Adding rule: ${source} -> ${target}`);
                        addRule(source, target);
                        rulesCount++;
                    }
                    
                    console.log(`Successfully loaded ${rulesCount} mapping rules for ${entityType}`);
                    alert(`‚úÖ Successfully loaded ${rulesCount} existing mappings for ${entityType}`);
                })
                .catch(err => {
                    console.error("Error loading mappings:", err);
                    alert(`‚ùå Could not load mappings for ${entityType}: ${err.message}\n\nPlease make sure the mapping file exists or create a new mapping.`);
                    
                    // Clear any existing rules since we couldn't load
                    document.getElementById('mapping-rules').innerHTML = '';
                });
        }

        // Enhanced save function with better feedback
        function saveMapping() {
            const entityType = document.getElementById('entity-type').value;
            
            if (!entityType) {
                alert('Please select an entity type first');
                return;
            }
            
            const rules = {};
            let isValid = true;
            let rulesCount = 0;
            
            // Collect all rules and validate
            document.querySelectorAll('.mapping-rule').forEach(rule => {
                const sourceField = rule.querySelector('.source-field').value;
                const targetField = rule.querySelector('.target-field').value;
                
                if (!sourceField || !targetField) {
                    alert('Please select both fields for each mapping!');
                    isValid = false;
                    return;
                }
                
                rules[sourceField] = targetField;
                rulesCount++;
            });
            
            if (!isValid) return;
            
            if (rulesCount === 0) {
                alert('Please add at least one mapping rule before saving.');
                return;
            }
            
            console.log(`Saving ${rulesCount} mapping rules for ${entityType}:`, rules);
            
            // Save the mapping
            fetch(`/mappings/${entityType}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(rules)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Save response:', data);
                if (data.status === 'success') {
                    alert(`‚úÖ Successfully saved ${rulesCount} mapping rules for ${entityType}!`);
                } else {
                    alert(`Error saving: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(err => {
                console.error("Error saving mappings:", err);
                alert('Error saving: ' + err.message);
            });
        }

        // Initialize when page loads
        window.onload = function() {
            loadEntityTypes();
        };
    </script>
</body>
</html>